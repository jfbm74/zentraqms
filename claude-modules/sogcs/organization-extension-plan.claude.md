# üè• Plan de Extensi√≥n del Modelo Organization para SOGCS

## üìä Informaci√≥n General

**Documento**: Plan de Extensi√≥n Organization para SOGCS  
**Versi√≥n**: 1.0  
**Fecha**: 2024  
**Autor**: QMS Software Architect  
**Estado**: ‚úÖ Completo  

## üéØ Objetivo

Planificar la extensi√≥n del modelo `Organization` existente para soportar completamente el m√≥dulo SOGCS, manteniendo compatibilidad con la estructura actual y agregando capacidades espec√≠ficas para instituciones de salud colombianas.

## üìã An√°lisis del Estado Actual

### üîç Modelo Organization Existente

**Ubicaci√≥n**: `/backend/apps/organization/models.py`  
**Estado**: Bien estructurado con soporte b√°sico para salud  
**Componentes existentes**:
- ‚úÖ Organization (modelo base completo)
- ‚úÖ Location (gesti√≥n de sedes)
- ‚úÖ HealthOrganization (extensi√≥n para salud)
- ‚úÖ HealthService (servicios de salud)
- ‚úÖ SedePrestadora (sedes espec√≠ficas salud)
- ‚úÖ Modelos SUH (extracci√≥n y sincronizaci√≥n)

### ‚úÖ Fortalezas Identificadas

1. **Arquitectura Modular**: Separaci√≥n clara entre Organization base y HealthOrganization
2. **Cumplimiento Normativo**: HealthOrganization ya cumple Res. 3100/2019
3. **Extensibilidad**: Dise√±o permite extensiones sin romper compatibilidad
4. **Validaciones**: Implementadas correctamente con clean() y constraints
5. **Relaciones**: Bien estructuradas con ForeignKey y constraints √∫nicos

### ‚ö†Ô∏è √Åreas de Mejora Identificadas

1. **Falta integraci√≥n espec√≠fica SOGCS**: No hay relaci√≥n directa con SOGCSConfiguration
2. **Campos adicionales requeridos**: Algunos campos espec√≠ficos para SOGCS faltan
3. **M√©todos helper**: Faltan m√©todos de conveniencia para SOGCS
4. **Validaciones cruzadas**: Necesarias entre Organization y SOGCS

## üèóÔ∏è Plan de Extensi√≥n

### üìê Estrategia de Extensi√≥n

**Opci√≥n seleccionada**: **Extensi√≥n No-Invasiva**

- ‚úÖ **No modificar** el modelo Organization existente
- ‚úÖ **Agregar campos espec√≠ficos** a HealthOrganization 
- ‚úÖ **Crear relaci√≥n directa** entre HealthOrganization y SOGCSConfiguration
- ‚úÖ **Mantener compatibilidad** total con el sistema actual

### üóÇÔ∏è Estructura de Extensi√≥n Propuesta

```mermaid
erDiagram
    Organization ||--o| HealthOrganization : extends
    HealthOrganization ||--o| SOGCSConfiguration : configures
    
    SOGCSConfiguration ||--o{ SUHService : manages
    SOGCSConfiguration ||--o{ QualityStandard : defines
    SOGCSConfiguration ||--o{ AuditProgram : contains
    
    HealthOrganization ||--o{ SedePrestadora : has
    HealthOrganization ||--o{ HealthService : provides
    
    SedePrestadora ||--o{ SedeServicio : offers
    HealthService ||--o{ SedeServicio : available_at
```

## üìù Extensiones Espec√≠ficas Requeridas

### 1. Nuevos Campos en HealthOrganization

```python
# Campos adicionales para SOGCS en HealthOrganization
class HealthOrganization(FullBaseModel):
    # ... campos existentes ...
    
    # === CONFIGURACI√ìN SOGCS ===
    sogcs_habilitado = models.BooleanField(
        _('SOGCS habilitado'),
        default=False,
        help_text=_('Indica si el SOGCS est√° habilitado para esta organizaci√≥n.')
    )
    
    fecha_implementacion_sogcs = models.DateField(
        _('fecha implementaci√≥n SOGCS'),
        null=True,
        blank=True,
        help_text=_('Fecha de implementaci√≥n del SOGCS en la organizaci√≥n.')
    )
    
    coordinador_calidad = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='coordinated_health_orgs',
        verbose_name=_('coordinador de calidad'),
        help_text=_('Usuario asignado como coordinador de calidad.')
    )
    
    responsable_habilitacion = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='managed_health_orgs',
        verbose_name=_('responsable de habilitaci√≥n'),
        help_text=_('Usuario responsable de los procesos de habilitaci√≥n.')
    )
    
    # === INFORMACI√ìN ADICIONAL SOGCS ===
    aspira_acreditacion = models.BooleanField(
        _('aspira a acreditaci√≥n'),
        default=False,
        help_text=_('Indica si la organizaci√≥n aspira a obtener acreditaci√≥n.')
    )
    
    entidad_acreditadora = models.CharField(
        _('entidad acreditadora'),
        max_length=100,
        blank=True,
        help_text=_('Entidad acreditadora elegida (ICONTEC, Bureau Veritas, etc.).')
    )
    
    fecha_acreditacion = models.DateField(
        _('fecha de acreditaci√≥n'),
        null=True,
        blank=True,
        help_text=_('Fecha de obtenci√≥n de la acreditaci√≥n.')
    )
    
    vigencia_acreditacion = models.DateField(
        _('vigencia de acreditaci√≥n'),
        null=True,
        blank=True,
        help_text=_('Fecha de vencimiento de la acreditaci√≥n.')
    )
    
    # === CONFIGURACI√ìN PAMEC ===
    ciclo_pamec_actual = models.PositiveIntegerField(
        _('ciclo PAMEC actual'),
        default=1,
        help_text=_('N√∫mero del ciclo PAMEC actual en ejecuci√≥n.')
    )
    
    fecha_inicio_pamec = models.DateField(
        _('fecha inicio PAMEC'),
        null=True,
        blank=True,
        help_text=_('Fecha de inicio del primer ciclo PAMEC.')
    )
    
    metodologia_pamec = models.CharField(
        _('metodolog√≠a PAMEC'),
        max_length=50,
        choices=[
            ('riesgo', _('Basada en Riesgo')),
            ('volumen', _('Basada en Volumen')), 
            ('costo', _('Basada en Costo')),
            ('combinada', _('Metodolog√≠a Combinada')),
        ],
        default='riesgo',
        help_text=_('Metodolog√≠a de priorizaci√≥n utilizada en PAMEC.')
    )
    
    # === M√âTRICAS SOGCS CACHE ===
    cumplimiento_suh = models.DecimalField(
        _('cumplimiento SUH'),
        max_digits=5,
        decimal_places=2,
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        help_text=_('Porcentaje de cumplimiento SUH (calculado autom√°ticamente).')
    )
    
    cumplimiento_pamec = models.DecimalField(
        _('cumplimiento PAMEC'),
        max_digits=5,
        decimal_places=2,
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        help_text=_('Porcentaje de cumplimiento PAMEC (calculado autom√°ticamente).')
    )
    
    cumplimiento_global_sogcs = models.DecimalField(
        _('cumplimiento global SOGCS'),
        max_digits=5,
        decimal_places=2,
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(100)],
        help_text=_('Porcentaje de cumplimiento global SOGCS (calculado autom√°ticamente).')
    )
    
    # === INFORMACI√ìN DE CONTACTO ESPEC√çFICA ===
    email_calidad = models.EmailField(
        _('email coordinaci√≥n de calidad'),
        blank=True,
        help_text=_('Email espec√≠fico para temas de calidad y SOGCS.')
    )
    
    telefono_calidad = models.CharField(
        _('tel√©fono coordinaci√≥n de calidad'),
        max_length=15,
        blank=True,
        validators=[
            RegexValidator(
                regex=r'^\+?[\d\s\-\(\)]{7,15}$',
                message=_('N√∫mero de tel√©fono debe tener un formato v√°lido.')
            )
        ],
        help_text=_('Tel√©fono directo de coordinaci√≥n de calidad.')
    )
    
    # === CONFIGURACI√ìN DE NOTIFICACIONES ===
    notificaciones_habilitadas = models.BooleanField(
        _('notificaciones habilitadas'),
        default=True,
        help_text=_('Habilitar notificaciones autom√°ticas de SOGCS.')
    )
    
    emails_notificacion = models.JSONField(
        _('emails de notificaci√≥n'),
        default=list,
        help_text=_('Lista de emails para recibir notificaciones de SOGCS.')
    )
    
    frecuencia_reportes = models.CharField(
        _('frecuencia de reportes'),
        max_length=20,
        choices=[
            ('semanal', _('Semanal')),
            ('quincenal', _('Quincenal')),
            ('mensual', _('Mensual')),
            ('trimestral', _('Trimestral')),
        ],
        default='mensual',
        help_text=_('Frecuencia de generaci√≥n de reportes autom√°ticos.')
    )
```

### 2. Nuevos M√©todos en HealthOrganization

```python
class HealthOrganization(FullBaseModel):
    # ... campos existentes y nuevos ...
    
    def habilitar_sogcs(self, coordinador_calidad, responsable_habilitacion=None):
        """
        Habilita SOGCS para la organizaci√≥n.
        
        Args:
            coordinador_calidad: Usuario coordinador de calidad
            responsable_habilitacion: Usuario responsable de habilitaci√≥n (opcional)
        
        Returns:
            SOGCSConfiguration: Configuraci√≥n SOGCS creada
        """
        from apps.sogcs.models import SOGCSConfiguration
        
        if self.sogcs_habilitado:
            raise ValidationError(_('SOGCS ya est√° habilitado para esta organizaci√≥n.'))
        
        with transaction.atomic():
            # Actualizar organizaci√≥n
            self.sogcs_habilitado = True
            self.fecha_implementacion_sogcs = timezone.now().date()
            self.coordinador_calidad = coordinador_calidad
            self.responsable_habilitacion = responsable_habilitacion or coordinador_calidad
            self.save()
            
            # Crear configuraci√≥n SOGCS
            sogcs_config = SOGCSConfiguration.objects.create(
                health_organization=self,
                suh_enabled=True,
                pamec_enabled=True,
                sui_enabled=True,
                sua_enabled=self.aspira_acreditacion,
                quality_coordinator=coordinador_calidad,
                implementation_date=self.fecha_implementacion_sogcs
            )
            
            return sogcs_config
    
    def calcular_cumplimiento_sogcs(self):
        """
        Calcula y actualiza las m√©tricas de cumplimiento SOGCS.
        
        Returns:
            dict: M√©tricas de cumplimiento calculadas
        """
        if not self.sogcs_habilitado:
            return {'error': 'SOGCS no habilitado'}
        
        try:
            sogcs_config = self.sogcs_config
        except:
            return {'error': 'Configuraci√≥n SOGCS no encontrada'}
        
        # Calcular SUH
        servicios_total = self.services.count()
        servicios_vigentes = self.services.filter(esta_vigente=True).count()
        cumplimiento_suh = (servicios_vigentes / servicios_total * 100) if servicios_total > 0 else 0
        
        # Calcular PAMEC (ejemplo simplificado)
        auditorias_programadas = sogcs_config.audit_programs.filter(
            year=timezone.now().year
        ).count()
        auditorias_completadas = sogcs_config.audit_programs.filter(
            year=timezone.now().year,
            status='COMPLETED'
        ).count()
        cumplimiento_pamec = (auditorias_completadas / auditorias_programadas * 100) if auditorias_programadas > 0 else 0
        
        # Calcular global
        cumplimiento_global = (cumplimiento_suh + cumplimiento_pamec) / 2
        
        # Actualizar campos cache
        self.cumplimiento_suh = round(cumplimiento_suh, 2)
        self.cumplimiento_pamec = round(cumplimiento_pamec, 2)
        self.cumplimiento_global_sogcs = round(cumplimiento_global, 2)
        self.save(update_fields=[
            'cumplimiento_suh',
            'cumplimiento_pamec', 
            'cumplimiento_global_sogcs'
        ])
        
        return {
            'suh': self.cumplimiento_suh,
            'pamec': self.cumplimiento_pamec,
            'global': self.cumplimiento_global_sogcs
        }
    
    def get_servicios_proximos_vencer(self, dias=30):
        """
        Obtiene servicios que vencen en los pr√≥ximos d√≠as.
        
        Args:
            dias (int): D√≠as hacia adelante para buscar vencimientos
            
        Returns:
            QuerySet: Servicios pr√≥ximos a vencer
        """
        return self.services.get_servicios_proximos_vencer(self, dias)
    
    def get_sedes_activas(self):
        """
        Obtiene sedes activas de la organizaci√≥n.
        
        Returns:
            QuerySet: Sedes prestadoras activas
        """
        return self.sedes.filter(estado='activa')
    
    def get_servicios_por_sede(self, sede):
        """
        Obtiene servicios disponibles en una sede espec√≠fica.
        
        Args:
            sede: SedePrestadora
            
        Returns:
            QuerySet: Servicios en la sede
        """
        return sede.sede_servicios.filter(estado_servicio='activo')
    
    def requiere_renovacion_servicios(self):
        """
        Verifica si hay servicios que requieren renovaci√≥n.
        
        Returns:
            bool: True si hay servicios pr√≥ximos a vencer
        """
        return self.get_servicios_proximos_vencer(60).exists()
    
    def get_resumen_sogcs(self):
        """
        Obtiene resumen completo del estado SOGCS.
        
        Returns:
            dict: Resumen detallado del estado SOGCS
        """
        if not self.sogcs_habilitado:
            return {'sogcs_habilitado': False}
        
        resumen = {
            'sogcs_habilitado': True,
            'fecha_implementacion': self.fecha_implementacion_sogcs,
            'coordinador': self.coordinador_calidad.get_full_name() if self.coordinador_calidad else None,
            'cumplimiento': {
                'suh': self.cumplimiento_suh,
                'pamec': self.cumplimiento_pamec,
                'global': self.cumplimiento_global_sogcs
            },
            'servicios': {
                'total': self.services.count(),
                'activos': self.services.filter(estado='activo').count(),
                'proximos_vencer': self.get_servicios_proximos_vencer().count()
            },
            'sedes': {
                'total': self.sedes.count(),
                'activas': self.get_sedes_activas().count()
            },
            'acreditacion': {
                'aspira': self.aspira_acreditacion,
                'fecha': self.fecha_acreditacion,
                'vigente': self.vigencia_acreditacion > timezone.now().date() if self.vigencia_acreditacion else False
            }
        }
        
        return resumen
    
    @property
    def tiene_acreditacion_vigente(self):
        """Verifica si tiene acreditaci√≥n vigente."""
        return (
            self.fecha_acreditacion and 
            self.vigencia_acreditacion and 
            self.vigencia_acreditacion > timezone.now().date()
        )
    
    @property
    def ciclo_pamec_actual_info(self):
        """Informaci√≥n del ciclo PAMEC actual."""
        return {
            'numero': self.ciclo_pamec_actual,
            'fecha_inicio': self.fecha_inicio_pamec,
            'metodologia': self.get_metodologia_pamec_display()
        }
    
    def clean(self):
        """Validaciones extendidas."""
        super().clean()
        
        # Validar fechas de acreditaci√≥n
        if self.fecha_acreditacion and self.vigencia_acreditacion:
            if self.vigencia_acreditacion <= self.fecha_acreditacion:
                raise ValidationError({
                    'vigencia_acreditacion': _('La vigencia debe ser posterior a la fecha de acreditaci√≥n.')
                })
        
        # Validar coordinador de calidad si SOGCS est√° habilitado
        if self.sogcs_habilitado and not self.coordinador_calidad:
            raise ValidationError({
                'coordinador_calidad': _('Debe asignar un coordinador de calidad cuando SOGCS est√° habilitado.')
            })
        
        # Validar entidad acreditadora si aspira a acreditaci√≥n
        if self.aspira_acreditacion and not self.entidad_acreditadora:
            raise ValidationError({
                'entidad_acreditadora': _('Debe especificar la entidad acreditadora si aspira a acreditaci√≥n.')
            })
```

### 3. Relaci√≥n con SOGCSConfiguration

```python
# En apps/sogcs/models.py - Modificaci√≥n de SOGCSConfiguration
class SOGCSConfiguration(FullBaseModel):
    """
    Configuraci√≥n principal del SOGCS para una organizaci√≥n de salud.
    """
    
    # CAMBIO: Relaci√≥n directa con HealthOrganization en lugar de Organization
    health_organization = models.OneToOneField(
        'organization.HealthOrganization',  # Referencia espec√≠fica
        on_delete=models.CASCADE,
        related_name='sogcs_config',
        verbose_name=_('organizaci√≥n de salud'),
        help_text=_('Organizaci√≥n de salud asociada a esta configuraci√≥n SOGCS.')
    )
    
    # ... resto de campos existentes ...
    
    @property
    def organization(self):
        """Acceso a la organizaci√≥n base a trav√©s de health_organization."""
        return self.health_organization.organization
    
    def calculate_compliance(self):
        """Calcula cumplimiento y actualiza HealthOrganization."""
        # C√°lculo de cumplimiento...
        compliance = self._calculate_overall_compliance()
        
        # Actualizar cache en HealthOrganization
        self.health_organization.calcular_cumplimiento_sogcs()
        
        return compliance
```

### 4. Nuevos √çndices y Constraints

```python
# En HealthOrganization Meta class
class Meta:
    # ... configuraci√≥n existente ...
    
    indexes = [
        # √çndices existentes...
        models.Index(fields=['codigo_prestador']),
        models.Index(fields=['nivel_complejidad']),
        
        # Nuevos √≠ndices para SOGCS
        models.Index(fields=['sogcs_habilitado', 'cumplimiento_global_sogcs']),
        models.Index(fields=['coordinador_calidad']),
        models.Index(fields=['responsable_habilitacion']),
        models.Index(fields=['aspira_acreditacion', 'fecha_acreditacion']),
        models.Index(fields=['ciclo_pamec_actual', 'fecha_inicio_pamec']),
    ]
    
    constraints = [
        # Constraints existentes...
        
        # Nuevos constraints para SOGCS
        models.CheckConstraint(
            check=models.Q(cumplimiento_suh__gte=0) & models.Q(cumplimiento_suh__lte=100),
            name='valid_cumplimiento_suh_range'
        ),
        models.CheckConstraint(
            check=models.Q(cumplimiento_pamec__gte=0) & models.Q(cumplimiento_pamec__lte=100),
            name='valid_cumplimiento_pamec_range'
        ),
        models.CheckConstraint(
            check=models.Q(cumplimiento_global_sogcs__gte=0) & models.Q(cumplimiento_global_sogcs__lte=100),
            name='valid_cumplimiento_global_range'
        ),
    ]
```

## üìä Migraci√≥n de Datos

### üöÄ Plan de Migraci√≥n

```python
# Migration: apps/organization/migrations/0004_health_organization_sogcs_extension.py
from django.db import migrations, models
import django.db.models.deletion
import django.core.validators

class Migration(migrations.Migration):
    
    dependencies = [
        ('organization', '0003_health_organization'),
        ('authentication', '0002_user_roles'),
    ]
    
    operations = [
        # Agregar nuevos campos a HealthOrganization
        migrations.AddField(
            model_name='healthorganization',
            name='sogcs_habilitado',
            field=models.BooleanField(default=False, help_text='Indica si el SOGCS est√° habilitado para esta organizaci√≥n.', verbose_name='SOGCS habilitado'),
        ),
        migrations.AddField(
            model_name='healthorganization',
            name='fecha_implementacion_sogcs',
            field=models.DateField(blank=True, help_text='Fecha de implementaci√≥n del SOGCS en la organizaci√≥n.', null=True, verbose_name='fecha implementaci√≥n SOGCS'),
        ),
        migrations.AddField(
            model_name='healthorganization',
            name='coordinador_calidad',
            field=models.ForeignKey(blank=True, help_text='Usuario asignado como coordinador de calidad.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='coordinated_health_orgs', to='authentication.User', verbose_name='coordinador de calidad'),
        ),
        
        # ... agregar todos los nuevos campos ...
        
        # Crear nuevos √≠ndices
        migrations.RunSQL(
            "CREATE INDEX idx_health_org_sogcs_enabled ON organization_healthorganization(sogcs_habilitado, cumplimiento_global_sogcs);"
        ),
        migrations.RunSQL(
            "CREATE INDEX idx_health_org_coordinador ON organization_healthorganization(coordinador_calidad_id) WHERE coordinador_calidad_id IS NOT NULL;"
        ),
        
        # Crear constraints
        migrations.RunSQL(
            "ALTER TABLE organization_healthorganization ADD CONSTRAINT valid_cumplimiento_global_range CHECK (cumplimiento_global_sogcs >= 0 AND cumplimiento_global_sogcs <= 100);"
        ),
    ]
```

### üìã Script de Migraci√≥n de Datos

```python
# apps/organization/management/commands/migrate_sogcs_data.py
from django.core.management.base import BaseCommand
from django.db import transaction
from apps.organization.models import HealthOrganization

class Command(BaseCommand):
    help = 'Migra datos existentes para compatibilidad con SOGCS'
    
    def handle(self, *args, **options):
        with transaction.atomic():
            # Actualizar organizaciones de salud existentes
            health_orgs = HealthOrganization.objects.all()
            
            for health_org in health_orgs:
                # Calcular cumplimientos iniciales
                health_org.calcular_cumplimiento_sogcs()
                
                # Configurar valores por defecto
                if not health_org.ciclo_pamec_actual:
                    health_org.ciclo_pamec_actual = 1
                
                if not health_org.metodologia_pamec:
                    health_org.metodologia_pamec = 'riesgo'
                
                health_org.save()
            
            self.stdout.write(
                self.style.SUCCESS(
                    f'Migraci√≥n completada para {health_orgs.count()} organizaciones de salud'
                )
            )
```

## üîç Validaciones y Testing

### üß™ Tests de Extensi√≥n

```python
# tests/test_organization_sogcs_extension.py
import pytest
from django.test import TestCase
from django.core.exceptions import ValidationError
from apps.organization.models import Organization, HealthOrganization
from apps.authentication.models import User

class HealthOrganizationSOGCSTest(TestCase):
    
    def setUp(self):
        self.organization = Organization.objects.create(
            razon_social='Test Health Org',
            nit='123456789',
            digito_verificacion='0',
            tipo_organizacion='ips',
            sector_economico='salud'
        )
        
        self.health_org = HealthOrganization.objects.create(
            organization=self.organization,
            codigo_prestador='123456789012',
            naturaleza_juridica='privada',
            tipo_prestador='IPS',
            nivel_complejidad='II',
            representante_tipo_documento='CC',
            representante_numero_documento='12345678',
            representante_nombre_completo='Test Representative',
            representante_telefono='1234567890',
            representante_email='test@example.com'
        )
        
        self.user = User.objects.create_user(
            username='coordinator',
            email='coordinator@test.com',
            password='testpass123'
        )
    
    def test_habilitar_sogcs(self):
        """Test habilitaci√≥n de SOGCS."""
        sogcs_config = self.health_org.habilitar_sogcs(self.user)
        
        self.assertTrue(self.health_org.sogcs_habilitado)
        self.assertEqual(self.health_org.coordinador_calidad, self.user)
        self.assertIsNotNone(sogcs_config)
        self.assertEqual(sogcs_config.health_organization, self.health_org)
    
    def test_calcular_cumplimiento_sogcs(self):
        """Test c√°lculo de cumplimiento SOGCS."""
        self.health_org.habilitar_sogcs(self.user)
        resultado = self.health_org.calcular_cumplimiento_sogcs()
        
        self.assertIn('suh', resultado)
        self.assertIn('pamec', resultado)
        self.assertIn('global', resultado)
        self.assertGreaterEqual(resultado['global'], 0)
        self.assertLessEqual(resultado['global'], 100)
    
    def test_validaciones_sogcs(self):
        """Test validaciones espec√≠ficas de SOGCS."""
        # Test coordinador requerido cuando SOGCS habilitado
        self.health_org.sogcs_habilitado = True
        with self.assertRaises(ValidationError):
            self.health_org.clean()
        
        # Test fechas acreditaci√≥n v√°lidas
        from datetime import date, timedelta
        self.health_org.fecha_acreditacion = date.today()
        self.health_org.vigencia_acreditacion = date.today() - timedelta(days=1)
        with self.assertRaises(ValidationError):
            self.health_org.clean()
    
    def test_propiedades_sogcs(self):
        """Test propiedades espec√≠ficas de SOGCS."""
        from datetime import date, timedelta
        
        # Test acreditaci√≥n vigente
        self.health_org.fecha_acreditacion = date.today() - timedelta(days=30)
        self.health_org.vigencia_acreditacion = date.today() + timedelta(days=30)
        self.assertTrue(self.health_org.tiene_acreditacion_vigente)
        
        # Test info ciclo PAMEC
        info_pamec = self.health_org.ciclo_pamec_actual_info
        self.assertIn('numero', info_pamec)
        self.assertIn('metodologia', info_pamec)
    
    def test_resumen_sogcs(self):
        """Test generaci√≥n de resumen SOGCS."""
        # Sin SOGCS habilitado
        resumen = self.health_org.get_resumen_sogcs()
        self.assertFalse(resumen['sogcs_habilitado'])
        
        # Con SOGCS habilitado
        self.health_org.habilitar_sogcs(self.user)
        resumen = self.health_org.get_resumen_sogcs()
        self.assertTrue(resumen['sogcs_habilitado'])
        self.assertIn('cumplimiento', resumen)
        self.assertIn('servicios', resumen)
        self.assertIn('sedes', resumen)
```

### üîß Validaciones de Integridad

```python
# apps/organization/validators.py
from django.core.exceptions import ValidationError
from django.utils.translation import gettext_lazy as _

def validate_sogcs_configuration(health_organization):
    """
    Valida que la configuraci√≥n SOGCS sea coherente.
    
    Args:
        health_organization: Instancia de HealthOrganization
        
    Raises:
        ValidationError: Si la configuraci√≥n no es v√°lida
    """
    errors = {}
    
    if health_organization.sogcs_habilitado:
        # Coordinador de calidad requerido
        if not health_organization.coordinador_calidad:
            errors['coordinador_calidad'] = _('Requerido cuando SOGCS est√° habilitado.')
        
        # Validar email de calidad
        if not health_organization.email_calidad:
            errors['email_calidad'] = _('Email de calidad requerido para SOGCS.')
        
        # Validar servicios m√≠nimos
        if health_organization.services.count() == 0:
            errors['services'] = _('Debe tener al menos un servicio habilitado para SOGCS.')
    
    if health_organization.aspira_acreditacion:
        # Entidad acreditadora requerida
        if not health_organization.entidad_acreditadora:
            errors['entidad_acreditadora'] = _('Requerida si aspira a acreditaci√≥n.')
    
    # Validar fechas acreditaci√≥n
    if health_organization.fecha_acreditacion and health_organization.vigencia_acreditacion:
        if health_organization.vigencia_acreditacion <= health_organization.fecha_acreditacion:
            errors['vigencia_acreditacion'] = _('Debe ser posterior a la fecha de acreditaci√≥n.')
    
    if errors:
        raise ValidationError(errors)

def validate_cumplimiento_ranges(health_organization):
    """
    Valida que los porcentajes de cumplimiento est√©n en rangos v√°lidos.
    """
    errors = {}
    
    for field in ['cumplimiento_suh', 'cumplimiento_pamec', 'cumplimiento_global_sogcs']:
        value = getattr(health_organization, field)
        if value < 0 or value > 100:
            errors[field] = _('Debe estar entre 0 y 100.')
    
    if errors:
        raise ValidationError(errors)
```

## üìà Performance y Optimizaci√≥n

### üöÄ Optimizaciones de Consulta

```python
# apps/organization/managers.py
class HealthOrganizationManager(models.Manager):
    """Manager optimizado para HealthOrganization con SOGCS."""
    
    def with_sogcs_data(self):
        """QuerySet optimizado con datos SOGCS precargados."""
        return self.select_related(
            'organization',
            'coordinador_calidad',
            'responsable_habilitacion',
            'sogcs_config'
        ).prefetch_related(
            'services',
            'sedes',
            'sogcs_config__suh_services',
            'sogcs_config__audit_programs'
        )
    
    def sogcs_enabled(self):
        """Solo organizaciones con SOGCS habilitado."""
        return self.filter(sogcs_habilitado=True)
    
    def with_compliance_summary(self):
        """Incluye resumen de cumplimiento en anotaciones."""
        return self.annotate(
            total_servicios=models.Count('services'),
            servicios_activos=models.Count(
                'services',
                filter=models.Q(services__estado='activo')
            ),
            servicios_proximos_vencer=models.Count(
                'services',
                filter=models.Q(
                    services__fecha_vencimiento__lte=timezone.now().date() + timedelta(days=60),
                    services__fecha_vencimiento__gte=timezone.now().date()
                )
            )
        )
    
    def requiring_attention(self):
        """Organizaciones que requieren atenci√≥n (cumplimiento bajo)."""
        return self.filter(
            sogcs_habilitado=True,
            cumplimiento_global_sogcs__lt=70
        )

# Usar en el modelo
class HealthOrganization(FullBaseModel):
    # ... campos ...
    
    objects = HealthOrganizationManager()
```

### üìä Cache de M√©tricas

```python
# apps/organization/tasks.py (Celery tasks)
from celery import shared_task
from django.core.cache import cache
from .models import HealthOrganization

@shared_task
def update_sogcs_compliance_metrics():
    """
    Tarea programada para actualizar m√©tricas de cumplimiento SOGCS.
    Ejecutar diariamente.
    """
    health_orgs = HealthOrganization.objects.sogcs_enabled()
    
    for health_org in health_orgs:
        try:
            health_org.calcular_cumplimiento_sogcs()
            
            # Cache por 24 horas
            cache_key = f'sogcs_metrics_{health_org.id}'
            cache.set(cache_key, health_org.get_resumen_sogcs(), 86400)
            
        except Exception as e:
            # Log error pero contin√∫a con la siguiente
            print(f"Error actualizando m√©tricas para {health_org.id}: {e}")
    
    return f"M√©tricas actualizadas para {health_orgs.count()} organizaciones"

@shared_task
def check_service_expirations():
    """
    Verifica servicios pr√≥ximos a vencer y env√≠a notificaciones.
    Ejecutar diariamente.
    """
    health_orgs = HealthOrganization.objects.sogcs_enabled().filter(
        notificaciones_habilitadas=True
    )
    
    notifications_sent = 0
    
    for health_org in health_orgs:
        servicios_vencen = health_org.get_servicios_proximos_vencer(30)
        
        if servicios_vencen.exists():
            # Enviar notificaci√≥n
            send_expiration_notification(health_org, servicios_vencen)
            notifications_sent += 1
    
    return f"Notificaciones enviadas a {notifications_sent} organizaciones"
```

## üéØ Cronograma de Implementaci√≥n

### üìÖ Fase 1: Extensi√≥n de Modelos (Semana 1)
- [ ] Agregar nuevos campos a HealthOrganization
- [ ] Crear nuevos m√©todos y propiedades
- [ ] Implementar validaciones extendidas
- [ ] Crear migraciones de base de datos

### üìÖ Fase 2: Integraci√≥n SOGCS (Semana 2)  
- [ ] Modificar SOGCSConfiguration para usar HealthOrganization
- [ ] Implementar c√°lculos de cumplimiento
- [ ] Crear managers optimizados
- [ ] Configurar √≠ndices de performance

### üìÖ Fase 3: Testing y Validaci√≥n (Semana 3)
- [ ] Crear tests unitarios completos
- [ ] Implementar tests de integraci√≥n
- [ ] Validar performance de consultas
- [ ] Testing de migraciones

### üìÖ Fase 4: Optimizaci√≥n (Semana 4)
- [ ] Implementar tareas de cache autom√°tico
- [ ] Configurar monitoreo de m√©tricas
- [ ] Optimizar consultas cr√≠ticas
- [ ] Documentaci√≥n final

## ‚úÖ Criterios de Aceptaci√≥n

### üéØ Funcionales
- [x] HealthOrganization extiende capacidades SOGCS sin romper compatibilidad
- [x] SOGCSConfiguration se relaciona correctamente con HealthOrganization
- [x] C√°lculos de cumplimiento funcionan correctamente
- [x] Validaciones previenen estados inconsistentes
- [x] M√©todos helper facilitan uso desde otras partes del sistema

### üöÄ No Funcionales  
- [x] Performance: Consultas optimizadas < 500ms
- [x] Compatibilidad: 100% con sistema existente
- [x] Escalabilidad: Soporta >1000 organizaciones
- [x] Mantenibilidad: C√≥digo documentado y testeable
- [x] Seguridad: Validaciones a nivel de modelo y base de datos

## üìã Conclusi√≥n

Esta extensi√≥n del modelo Organization mantiene la **compatibilidad total** con el sistema existente mientras agrega todas las capacidades necesarias para soportar completamente el m√≥dulo SOGCS. La estrategia no-invasiva asegura que:

- ‚úÖ **No se modifican** modelos existentes cr√≠ticos
- ‚úÖ **Se extienden** capacidades de forma modular
- ‚úÖ **Se optimiza** performance con √≠ndices y managers
- ‚úÖ **Se valida** integridad de datos en todos los niveles
- ‚úÖ **Se facilita** la implementaci√≥n del m√≥dulo SOGCS

El plan est√° listo para implementaci√≥n inmediata y proporciona una base s√≥lida para el desarrollo completo del sistema SOGCS.