# üöÄ Implementaci√≥n Backend - Modelos Base y Configuraci√≥n Inicial

## üìã Contexto del Proyecto

Estoy desarrollando un sistema de gesti√≥n de calidad con arquitectura separada (Django Backend + React Frontend). Necesito implementar la base del sistema de autenticaci√≥n que posteriormente soportar√° RBAC (Role-Based Access Control).

## üéØ Objetivo de esta Fase

Crear los modelos base de usuario y configurar Django + Django REST Framework para soportar una API RESTful con autenticaci√≥n JWT. Esta es la Fase 1.1 del desarrollo, que establece los cimientos para todo el sistema de autenticaci√≥n y autorizaci√≥n.

## üõ†Ô∏è Stack Tecnol√≥gico

- **Django 5.0** - Framework principal
- **Django REST Framework** - API RESTful  
- **PostgreSQL** - Base de datos
- **Redis** - Cache (configurar en siguiente fase)
- **Python 3.11+** - Lenguaje backend

## üì¶ Requerimientos de Implementaci√≥n

### 1. Custom User Model

Necesito crear un modelo de usuario personalizado que extienda `AbstractUser` de Django con los siguientes campos adicionales y consideraciones:

**Campos del Modelo User:**
```python
# Campos base de AbstractUser que mantener:
- username (opcional, permitir login con email)
- email (√∫nico, requerido, ser√° el campo principal de login)
- first_name
- last_name
- is_active
- is_staff
- is_superuser
- date_joined

# Campos adicionales a agregar:
- id (UUID en lugar de autoincrement)
- is_verified (BooleanField) - para verificaci√≥n de email
- last_login_ip (GenericIPAddressField, nullable)
- failed_login_attempts (IntegerField, default=0)
- locked_until (DateTimeField, nullable) - para bloqueo temporal
- created_by (ForeignKey to self, nullable) - qui√©n cre√≥ la cuenta
- updated_at (DateTimeField, auto_now=True)
- phone_number (CharField, opcional)
- department (CharField, opcional) - preparando para RBAC
- position (CharField, opcional) - cargo en la organizaci√≥n
```

**Configuraciones importantes:**
- USERNAME_FIELD = 'email'
- REQUIRED_FIELDS = ['first_name', 'last_name']
- Usar UUID como primary key para mejor seguridad
- Agregar √≠ndices en campos de b√∫squeda frecuente
- Implementar m√©todo `__str__` que retorne el email
- Agregar property `full_name` que combine first_name y last_name
- M√©todo `can_login()` que verifique is_active y locked_until

**Manager personalizado:**
- Crear UserManager personalizado
- Override `create_user` y `create_superuser`
- Normalizar email en la creaci√≥n
- Validar email √∫nico case-insensitive

### 2. Estructura del Proyecto

Organizar el proyecto Django con la siguiente estructura:
```
backend/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py       # Configuraciones comunes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ development.py # Config desarrollo
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ production.py  # Config producci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ testing.py     # Config para tests
‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îú‚îÄ‚îÄ wsgi.py
‚îÇ   ‚îî‚îÄ‚îÄ asgi.py
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ authentication/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py      # User model aqu√≠
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ managers.py    # UserManager aqu√≠
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ serializers.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ views.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ common/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ models.py      # Abstract models base
‚îÇ       ‚îî‚îÄ‚îÄ utils.py       # Utilidades compartidas
‚îú‚îÄ‚îÄ requirements/
‚îÇ   ‚îú‚îÄ‚îÄ base.txt
‚îÇ   ‚îú‚îÄ‚îÄ development.txt
‚îÇ   ‚îî‚îÄ‚îÄ production.txt
‚îî‚îÄ‚îÄ manage.py
```

### 3. Configuraci√≥n de Django Settings

**Settings Base (base.py):**
```python
# Configuraciones esenciales:
- SECRET_KEY desde variable de entorno
- DEBUG = False por defecto
- ALLOWED_HOSTS desde env
- AUTH_USER_MODEL = 'authentication.User'
- Configuraci√≥n de DATABASES para PostgreSQL
- Timezone: 'America/Bogota' (Colombia)
- USE_TZ = True
- LANGUAGE_CODE = 'es-co'

# Apps instaladas:
INSTALLED_APPS = [
    # Django apps
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    
    # Third party apps
    'rest_framework',
    'corsheaders',
    'django_filters',
    
    # Local apps
    'apps.authentication',
    'apps.common',
]

# Middleware importante:
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'corsheaders.middleware.CorsMiddleware',  # Antes de CommonMiddleware
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]
```

### 4. Configuraci√≥n de Django REST Framework

```python
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.SessionAuthentication',  # Por ahora
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.MultiPartParser',
        'rest_framework.parsers.FormParser',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
    'DEFAULT_SCHEMA_CLASS': 'rest_framework.schemas.coreapi.AutoSchema',
    'EXCEPTION_HANDLER': 'apps.common.utils.custom_exception_handler',
    'NON_FIELD_ERRORS_KEY': 'error',
    'DATETIME_FORMAT': '%Y-%m-%d %H:%M:%S',
    'DATE_FORMAT': '%Y-%m-%d',
}
```

### 5. Configuraci√≥n CORS

```python
# Para desarrollo (development.py):
CORS_ALLOW_ALL_ORIGINS = True  # Solo en desarrollo

# Para producci√≥n (production.py):
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://localhost:5173",  # Vite default
    # Agregar dominio de producci√≥n
]

# Configuraci√≥n com√∫n (base.py):
CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_METHODS = [
    'DELETE',
    'GET',
    'OPTIONS',
    'PATCH',
    'POST',
    'PUT',
]
CORS_ALLOW_HEADERS = [
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',
    'x-requested-with',
]
```

### 6. Migraciones Iniciales

Despu√©s de crear el modelo User:
1. Crear migraci√≥n inicial: `python manage.py makemigrations authentication`
2. Aplicar migraci√≥n: `python manage.py migrate`
3. Crear superusuario de prueba
4. Generar fixtures con datos de prueba

### 7. Admin Configuration

Configurar Django Admin para el modelo User con:
- Lista filtrable por: is_active, is_verified, is_staff
- B√∫squeda por: email, first_name, last_name
- Campos de solo lectura: date_joined, last_login
- Acciones personalizadas: unlock_users, verify_users
- Inline para futuros roles (preparaci√≥n)

### 8. Serializers B√°sicos

Crear serializers iniciales:
```python
# UserSerializer b√°sico
- Campos de lectura para perfil
- Validaci√≥n de email √∫nico
- Exclusi√≥n de campos sensibles (password, etc.)

# UserCreateSerializer
- Para registro de usuarios
- Validaci√≥n de contrase√±a fuerte
- Confirmaci√≥n de contrase√±a

# UserUpdateSerializer  
- Para actualizaci√≥n de perfil
- Campos editables limitados
```

### 9. Validaciones y Utilidades

**Validaciones personalizadas:**
- Validador de email √∫nico case-insensitive
- Validador de contrase√±a fuerte (m√≠nimo 8 caracteres, may√∫sculas, min√∫sculas, n√∫meros)
- Validador de formato de tel√©fono (Colombia)

**Utilidades comunes:**
- Generador de tokens √∫nicos
- Normalizador de emails
- Manejador de excepciones personalizado
- Logger configurado para auditor√≠a

### 10. Tests Unitarios

Crear tests para:
- Creaci√≥n de usuario con campos v√°lidos
- Validaci√≥n de email √∫nico
- M√©todo can_login()
- UserManager.create_user()
- UserManager.create_superuser()
- Validadores personalizados

## üìù Criterios de Aceptaci√≥n

1. ‚úÖ Modelo User personalizado funcional con todos los campos especificados
2. ‚úÖ Migraciones aplicadas sin errores
3. ‚úÖ Django Admin configurado y funcional
4. ‚úÖ Settings organizados por entornos
5. ‚úÖ CORS configurado correctamente
6. ‚úÖ DRF configurado con paginaci√≥n y filtros
7. ‚úÖ Tests b√°sicos pasando (m√≠nimo 80% cobertura en models)
8. ‚úÖ Documentaci√≥n de instalaci√≥n en README
9. ‚úÖ Requirements.txt organizado por entornos
10. ‚úÖ Variables de entorno documentadas (.env.example)

## üö® Consideraciones Importantes

1. **NO implementar JWT todav√≠a** - eso viene en la siguiente fase
2. **NO crear endpoints de API todav√≠a** - solo modelos y configuraci√≥n
3. **Usar PostgreSQL desde el inicio** - no SQLite
4. **Preparar estructura para RBAC** pero no implementar roles a√∫n
5. **Seguir convenciones de Django** y PEP 8
6. **Documentar cada decisi√≥n importante** en comentarios
7. **Usar type hints** donde sea posible
8. **Configurar logging** desde el inicio

## üîß Comandos de Verificaci√≥n

Despu√©s de la implementaci√≥n, estos comandos deben funcionar:
```bash
# Verificar modelo
python manage.py shell
>>> from apps.authentication.models import User
>>> User.objects.create_user(email='test@example.com', password='Test1234!')

# Verificar migraciones
python manage.py showmigrations

# Verificar admin
python manage.py createsuperuser

# Correr tests
python manage.py test apps.authentication

# Verificar configuraci√≥n
python manage.py check --deploy
```

## üìö Dependencias Requeridas

```txt
# requirements/base.txt
Django==5.0.0
djangorestframework==3.14.0
django-cors-headers==4.3.1
django-filter==23.5
python-decouple==3.8
psycopg2-binary==2.9.9
python-dotenv==1.0.0
pytz==2023.3

# requirements/development.txt
-r base.txt
django-debug-toolbar==4.2.0
ipython==8.18.1
pytest==7.4.3
pytest-django==4.7.0
pytest-cov==4.1.0
black==23.12.0
flake8==6.1.0
```

## üéØ Entregables Esperados

1. **C√≥digo fuente** con la estructura especificada
2. **README.md** con instrucciones de instalaci√≥n
3. **.env.example** con todas las variables necesarias
4. **Dockerfile** b√°sico para desarrollo (opcional)
5. **Makefile** con comandos comunes (opcional)

---

**Nota**: Esta implementaci√≥n es la base fundamental del sistema. Es cr√≠tico que est√© bien estructurada ya que todos los dem√°s componentes depender√°n de estos modelos y configuraciones. Tomar el tiempo necesario para hacerlo correctamente desde el inicio.